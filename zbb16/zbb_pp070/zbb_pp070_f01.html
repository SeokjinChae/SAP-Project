<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<html>
<head>
<title>ZBB_PP070_F01</title>
</head>
<body bgcolor="#FFFFE0">
<font size="3" face = "Arial" color="#000000"><b>Code listing for: ZBB_PP070_F01</b></font>
<br>
<font size="3" face = "Arial" color="#000000"><b>Description:  Include ZBB_PP070_F01</b></font>
<hr>
<pre width="100">
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Include          ZBB_PP070_F01</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form get_data</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM get_data .

  "생산오더 리스트 조회
  CASE 'X'.
    WHEN pa_st0.     "오더 승인 처리 대기
      SELECT a~porderno a~plantno c~plantnm a~matno b~matnm
             a~pplanno a~pordwdat a~empno a~pordcdat a~poutput a~unit a~price
             a~currency a~pordflag a~bomno a~orstatus a~rej_txt a~create_dt
             a~create_tm a~cuser
        INTO CORRESPONDING FIELDS OF TABLE gt_prdord
        FROM zbbt_pp060 AS a INNER JOIN zbbt_mm020 AS b
          ON a~matno = b~matno
        INNER JOIN zbbt_pp010 AS c
          ON a~plantno = c~plantno
        INNER JOIN zbbt_pp040 AS d
          ON a~matno = d~matno
        WHERE a~porderno IN so_pono
         AND a~pordwdat IN so_podt
         AND a~pordflag EQ '0'
         AND a~orstatus EQ ' '.

    WHEN pa_st1.      "오더 승인
      SELECT a~porderno a~plantno c~plantnm a~matno b~matnm
             a~pplanno a~pordwdat a~empno a~pordcdat a~poutput a~unit a~price
             a~currency a~pordflag a~bomno a~orstatus a~rej_txt a~create_dt
             a~create_tm a~cuser
         INTO CORRESPONDING FIELDS OF TABLE gt_prdord
         FROM zbbt_pp060 AS a INNER JOIN zbbt_mm020 AS b
             ON a~matno = b~matno
         INNER JOIN zbbt_pp010 AS c
             ON a~plantno = c~plantno
         INNER JOIN zbbt_pp040 AS d
             ON a~matno = d~matno
         WHERE a~porderno IN so_pono
           AND a~pordwdat IN so_podt
           AND a~orstatus EQ '1'.

    WHEN pa_st2.      "오더 반려
      SELECT a~porderno a~plantno c~plantnm a~matno b~matnm
             a~pplanno a~pordwdat a~empno a~pordcdat a~poutput a~unit a~price
             a~currency a~pordflag a~bomno a~orstatus a~rej_txt a~create_dt
             a~create_tm a~cuser
         INTO CORRESPONDING FIELDS OF TABLE gt_prdord
         FROM zbbt_pp060 AS a INNER JOIN zbbt_mm020 AS b
             ON a~matno = b~matno
         INNER JOIN zbbt_pp010 AS c
             ON a~plantno = c~plantno
         INNER JOIN zbbt_pp040 AS d
             ON a~matno = d~matno
         WHERE a~porderno IN so_pono
           AND a~pordwdat IN so_podt
           AND a~pordflag EQ '0'
           AND a~orstatus EQ '2'.
  ENDCASE.


ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form create_object</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM create_object .

  IF go_cont IS INITIAL.

    " 1) custom control area 에 container 를 link
    CREATE OBJECT go_cont
      EXPORTING
        container_name = 'MY_CONT' "100번 스크린에 생성한 이름
      EXCEPTIONS
        OTHERS         = 1.
    IF sy-subrc &lt;&gt; 0.

    ENDIF.

    " 2) container 에 grid 를 link.
    CREATE OBJECT go_grid
      EXPORTING
        i_parent = go_cont
      EXCEPTIONS
        OTHERS   = 1.
    IF sy-subrc &lt;&gt; 0.

    ENDIF.
  ENDIF.
ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_layout</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_layout .
  gs_layout-sel_mode = 'A'.
  gs_layout-zebra = 'X'.
  gs_layout-grid_title = '생산오더 목록'.

  "light 추가
  gs_layout-excp_fname = 'LIGHT'.
  gs_layout-excp_led = 'X'.

  "Line 컬러 적용
  gs_layout-info_fname = 'COLOR'.

  "셀 버튼 추가
  gs_layout-stylefname = 'IT_CELL_STYLE'.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_field_cat</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_field_cat .

  gs_field_cat-fieldname = 'LIGHT'.
  gs_field_cat-coltext   = '상태'.
  gs_field_cat-just   = 'C'.
  APPEND gs_field_cat TO gt_field_cat.
  CLEAR gs_field_cat.

  gs_field_cat-fieldname = 'PORDERNO'.
  gs_field_cat-coltext  = '생산오더번호'.
  gs_field_cat-outputlen = 10.
  gs_field_cat-key = 'X'.
  gs_field_cat-col_pos   = 1.
  gs_field_cat-just   = 'C'.
  APPEND gs_field_cat TO gt_field_cat.
  CLEAR gs_field_cat.

  gs_field_cat-fieldname = 'PORDWDAT'.
  gs_field_cat-coltext  = '오더생성일'.
  gs_field_cat-outputlen = 8.
  gs_field_cat-key = 'X'.
  gs_field_cat-col_pos   = 2.
  gs_field_cat-just   = 'C'.
  APPEND gs_field_cat TO gt_field_cat.
  CLEAR gs_field_cat.

  gs_field_cat-fieldname = 'MATNO'.
  gs_field_cat-coltext  = '자재번호'.
  gs_field_cat-outputlen = 6.
  gs_field_cat-key = 'X'.
  gs_field_cat-col_pos   = 3.
  gs_field_cat-just   = 'C'.
  APPEND gs_field_cat TO gt_field_cat.
  CLEAR gs_field_cat.

  gs_field_cat-fieldname = 'MATNM'.
  gs_field_cat-coltext  = '자재명'.
  gs_field_cat-outputlen = 17.
  gs_field_cat-col_pos   = 4.
  APPEND gs_field_cat TO gt_field_cat.
  CLEAR gs_field_cat.

  gs_field_cat-fieldname = 'POUTPUT'.
  gs_field_cat-coltext  = '수량'.
  gs_field_cat-outputlen = 5.
  gs_field_cat-qfieldname = 'UNIT'.
  gs_field_cat-col_pos   = 5.
  APPEND gs_field_cat TO gt_field_cat.
  CLEAR gs_field_cat.

  gs_field_cat-fieldname = 'UNIT'.
  gs_field_cat-coltext  = '단위'.
  gs_field_cat-outputlen = 3.
  gs_field_cat-col_pos   = 6.
  APPEND gs_field_cat TO gt_field_cat.
  CLEAR gs_field_cat.

  gs_field_cat-fieldname = 'PRICE'.
  gs_field_cat-coltext  = '생산금액'.
  gs_field_cat-currency = 'KRW'.
<font color ="#0000FF">*  gs_field_cat-no_out = 'X'.</font>
  gs_field_cat-outputlen = 8.
  gs_field_cat-col_pos   = 7.
  APPEND gs_field_cat TO gt_field_cat.
  CLEAR gs_field_cat.

  gs_field_cat-fieldname = 'CURRENCY'.
  gs_field_cat-coltext  = '통화'.
<font color ="#0000FF">*  gs_field_cat-no_out = 'X'.</font>
  gs_field_cat-outputlen = 4.
  gs_field_cat-col_pos   = 8.
  APPEND gs_field_cat TO gt_field_cat.
  CLEAR gs_field_cat.

  gs_field_cat-fieldname = 'BOMNO'.
  gs_field_cat-coltext  = 'BOM번호'.
  gs_field_cat-outputlen = 6.
  gs_field_cat-col_pos   = 9.
  gs_field_cat-just   = 'C'.
  IF gs_prdord-orstatus &lt;&gt; ' '.
    gs_field_cat-no_out = 'X'.
  ENDIF.
  APPEND gs_field_cat TO gt_field_cat.
  CLEAR gs_field_cat.

  gs_field_cat-fieldname = 'PLANTNO'.
  gs_field_cat-coltext  = '공장번호'.
  gs_field_cat-outputlen = 5.
  gs_field_cat-col_pos   = 10.
  gs_field_cat-just   = 'C'.
  APPEND gs_field_cat TO gt_field_cat.
  CLEAR gs_field_cat.

  gs_field_cat-fieldname = 'PLANTNM'.
  gs_field_cat-coltext  = '공장이름'.
  gs_field_cat-outputlen = 7.
  gs_field_cat-col_pos   = 11.
  gs_field_cat-no_out = 'X'.
  gs_field_cat-just   = 'C'.
  APPEND gs_field_cat TO gt_field_cat.
  CLEAR gs_field_cat.

  gs_field_cat-fieldname = 'PORDCDAT'.
  gs_field_cat-coltext  = '생산일'.
  gs_field_cat-outputlen = 8.
  gs_field_cat-col_pos   = 12.
  gs_field_cat-just   = 'C'.
  IF gs_prdord-orstatus &lt;&gt; '1'.
    gs_field_cat-no_out = 'X'.
  ENDIF.
  APPEND gs_field_cat TO gt_field_cat.
  CLEAR gs_field_cat.

  gs_field_cat-fieldname = 'PORDFLAG'.
<font color ="#0000FF">*  gs_field_cat-coltext  = ''.</font>
<font color ="#0000FF">*  gs_field_cat-col_pos   = 16.</font>
<font color ="#0000FF">*  gs_field_cat-outputlen = 1.</font>
  gs_field_cat-no_out = 'X'.
  APPEND gs_field_cat TO gt_field_cat.
  CLEAR gs_field_cat.

  gs_field_cat-fieldname = 'ORSTATTXT'.
  gs_field_cat-coltext  = '승인/반려'.
  gs_field_cat-outputlen = 7.
  gs_field_cat-just   = 'C'.
  gs_field_cat-no_out = 'X'.
  APPEND gs_field_cat TO gt_field_cat.
  CLEAR gs_field_cat.

  gs_field_cat-fieldname = 'APPROVAL_PORDER'.
  gs_field_cat-coltext  = '승인/반려'.
  gs_field_cat-just   = 'C'.
  gs_field_cat-outputlen = 7.
  gs_field_cat-col_pos   = 13.
  IF gs_prdord-orstatus IS NOT INITIAL .
    gs_field_cat-no_out = 'X'.
  ENDIF.
  APPEND gs_field_cat TO gt_field_cat.
  CLEAR gs_field_cat.

  gs_field_cat-fieldname = 'REJ_TXT'.
  gs_field_cat-coltext  = '반려사유'.
  gs_field_cat-outputlen = 13.
  gs_field_cat-col_pos   = 14.
  IF gs_prdord-orstatus &lt;&gt; '2'.
    gs_field_cat-no_out = 'X'.
  ENDIF.
  APPEND gs_field_cat TO gt_field_cat.
  CLEAR gs_field_cat.

  gs_field_cat-fieldname = 'PPLANNO'.
  gs_field_cat-coltext  = '생산계획번호'.
  gs_field_cat-outputlen = 10.
  gs_field_cat-col_pos   = 15.
  gs_field_cat-just   = 'C'.
  APPEND gs_field_cat TO gt_field_cat.
  CLEAR gs_field_cat.

  gs_field_cat-fieldname = 'PORDFTXT'.
  gs_field_cat-coltext  = '진행 단계'.
  gs_field_cat-outputlen = 14.
  gs_field_cat-col_pos   = 17.
  gs_field_cat-just   = 'C'.
  IF gs_prdord-orstatus EQ '2'.
    gs_field_cat-no_out = 'X'.
  ENDIF.
  APPEND gs_field_cat TO gt_field_cat.
  CLEAR gs_field_cat.

  gs_field_cat-fieldname = 'ORSTATUS'.
  gs_field_cat-coltext  = '오더상태'.
  gs_field_cat-col_pos   = 16.
  gs_field_cat-no_out = 'X'.
  APPEND gs_field_cat TO gt_field_cat.
  CLEAR gs_field_cat.



ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form display_table</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM display_table .
  CALL METHOD go_grid-&gt;set_table_for_first_display
    EXPORTING
      is_layout       = gs_layout
    CHANGING
      it_outtab       = gt_prdord
      it_fieldcatalog = gt_field_cat
      it_sort         = gt_sorting
    EXCEPTIONS
      OTHERS          = 1.
ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form display_data</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM display_data .
  DATA : lv_lin TYPE i.

  DESCRIBE TABLE gt_prdord LINES lv_lin.

  IF gt_prdord IS NOT INITIAL.
    MESSAGE s009 WITH lv_lin.  "&건의 데이터가 조회되었습니다.

    CALL SCREEN 100.
    LEAVE TO SCREEN 0.

  ELSE.
    MESSAGE s029 DISPLAY LIKE 'E'.    "데이터가 존재하지 않습니다.
    LEAVE TO LIST-PROCESSING.

  ENDIF.
ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form last_day_of_months</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM last_day_of_months .

  DATA : lv_date      TYPE dats,
         lv_last_date TYPE dats.

  lv_date = sy-datum.

  CALL FUNCTION 'RP_LAST_DAY_OF_MONTHS'
    EXPORTING
      day_in            = lv_date
    IMPORTING
      last_day_of_month = lv_last_date
    EXCEPTIONS
      day_in_no_date    = 1
      OTHERS            = 2.

  gv_last_date = lv_last_date.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form make_data</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM make_data .
  LOOP AT gt_prdord INTO gs_prdord.

    DATA : lv_text      TYPE dd07t-ddtext,
           lv_value(10) TYPE c.

    "1) 생산오더실행여부 txt 넣기
    lv_value = gs_prdord-pordflag.  "DOMAIN VALUE값

    CALL FUNCTION 'STF4_GET_DOMAIN_VALUE_TEXT'
      EXPORTING
        iv_domname    = 'ZBBD_PORDFLAG' "도메인 이름
        iv_value      = lv_value "도메인 VALUE 값
      IMPORTING
        ev_value_text = lv_text. "도메인 텍스트 받아올 변수

    gs_prdord-pordftxt = lv_text.
    MODIFY gt_prdord FROM gs_prdord TRANSPORTING pordftxt.
    CLEAR : lv_text, lv_value.

    IF gs_prdord-orstatus IS NOT INITIAL.
      "2) 오더상태 txt 넣기
      lv_value = gs_prdord-orstatus.  "DOMAIN VALUE값

      CALL FUNCTION 'STF4_GET_DOMAIN_VALUE_TEXT'
        EXPORTING
          iv_domname    = 'ZBBD_ORSTATUS' "도메인 이름
          iv_value      = lv_value "도메인 VALUE 값
        IMPORTING
          ev_value_text = lv_text. "도메인 텍스트 받아올 변수

      gs_prdord-orstattxt = lv_text.

      MODIFY gt_prdord FROM gs_prdord TRANSPORTING orstattxt.
    ENDIF.

    "3) 오더상태에 따른 신호등 추가
    IF gs_prdord-orstatus EQ 1 AND gs_prdord-pordflag EQ 2. "오더 승인/ 검수완료
      gs_prdord-light = '3'.
<font color ="#0000FF">*      gs_prdord-color = 'C' && col_positive && '00'.</font>
      gs_prdord-approval_porder = '승인완료'.

    ELSEIF gs_prdord-orstatus EQ 2 .           "오더 반려
      gs_prdord-light = '1'.
<font color ="#0000FF">*      gs_prdord-color = 'C' && col_negative && '00'.</font>
      gs_prdord-approval_porder = '오더 반려'.

    ELSEIF gs_prdord-orstatus IS INITIAL        "승인 대기
      AND gs_prdord-pordwdat &lt;= gv_date.
      gs_prdord-light = '1'.
      gs_prdord-color = 'C' && col_negative && '00'.

      "4) Cell 버튼 추가
      gs_cell_style-fieldname = 'APPROVAL_PORDER'.
      gs_cell_style-style = cl_gui_alv_grid=&gt;mc_style_button.

      APPEND gs_cell_style TO gs_prdord-it_cell_style.

      gs_prdord-approval_porder = '승인/반려'.

    ELSEIF gs_prdord-orstatus EQ 1 AND gs_prdord-pordflag EQ 1.
      gs_prdord-light = '3'.
<font color ="#0000FF">*      gs_prdord-color = 'C' && col_total && '00'.</font>

    ELSE.
      gs_prdord-light = '2'.

      "4) Cell 버튼 추가
      gs_cell_style-fieldname = 'APPROVAL_PORDER'.
      gs_cell_style-style = cl_gui_alv_grid=&gt;mc_style_button.

      APPEND gs_cell_style TO gs_prdord-it_cell_style.

      gs_prdord-approval_porder = '승인/반려'.

    ENDIF.

    MODIFY gt_prdord FROM gs_prdord TRANSPORTING light color approval_porder it_cell_style.

  ENDLOOP.
ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_handler</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_handler .

  CREATE OBJECT go_handler.

  SET HANDLER : go_handler-&gt;handle_button_click  FOR go_grid,
                go_handler-&gt;handle_toolbar FOR go_grid,
                go_handler-&gt;handle_user_command FOR go_grid.
ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_sorting</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_sorting .

  gs_sorting-spos = '1'.
  gs_sorting-fieldname = 'LIGHT'.
  APPEND gs_sorting TO gt_sorting.
  CLEAR gs_sorting.

  gs_sorting-spos = '2'.
  gs_sorting-fieldname = 'PORDWDAT'.
  APPEND gs_sorting TO gt_sorting.
  CLEAR gs_sorting.

  gs_sorting-spos = '4'.
  gs_sorting-fieldname = 'PORDERNO'.
  gs_sorting-up = 'X'.
  APPEND gs_sorting TO gt_sorting.
  CLEAR gs_sorting.

  gs_sorting-spos = '3'.
  gs_sorting-fieldname = 'PORDFTXT'.
  APPEND gs_sorting TO gt_sorting.
  CLEAR gs_sorting.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form button_click</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&      --&gt; ES_COL_ID</font>
<font color ="#0000FF">*&      --&gt; ES_ROW_NO</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM button_click  USING    ps_col_id
                            ps_row_no TYPE lvc_s_roid.

  gv_tabix = ps_row_no-row_id.

  CALL SCREEN 120 STARTING AT 10  10. "승인/반려 팝업

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form get_delay_num</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM get_delay_num .
  DATA : lv_date TYPE dats.

  lv_date = sy-datum.
  lv_date+6(2) = '01'.

  SELECT COUNT( porderno ) AS count
    FROM zbbt_pp060
    WHERE pordwdat &lt; @lv_date
     AND pordflag EQ '0'
     AND orstatus IS INITIAL
     INTO @DATA(lv_count).

  gv_count = lv_count.

  value1 = ||.
  value2 = |** 전 월 승인 미 처리건 수 : { gv_count } 건 |.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form modify_screen</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM modify_screen .

  "승인 대기 & 미처리건이 존재하는 경우만 활성화
  LOOP AT SCREEN.
    IF screen-name = 'SO_PTNO-LOW' OR  screen-name = 'SO_PTNO-HIGH'.
      screen-input = 0.
    ENDIF.
    MODIFY SCREEN.

    CASE 'X'.
      WHEN pa_st0.
        IF screen-group1 = 'COT' AND gv_count &lt;&gt; '00'.
          screen-active = '1'.
          screen-intensified = '1'.
        ELSEIF screen-group1 = 'COT' AND gv_count EQ '00'.
          screen-active = '0'.
        ENDIF.
      WHEN pa_st1.
        IF screen-group1 = 'COT'.
          screen-active = '0'.
        ENDIF.
      WHEN pa_st2.
        IF screen-group1 = 'COT'.
          screen-active = '0'.
        ENDIF.
    ENDCASE.

    MODIFY SCREEN.
  ENDLOOP.
ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form refresh_grid</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM refresh_grid .
  CALL METHOD go_grid-&gt;refresh_table_display( ).
ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form toolbar</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&      --&gt; E_OBJECT</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM toolbar   USING pc_object TYPE REF TO cl_alv_event_toolbar_set.

  DATA : ls_button TYPE stb_button.
  CLEAR gs_prdord.

  " 툴바 라인 추가
  ls_button-butn_type = 3.
  INSERT ls_button INTO TABLE pc_object-&gt;mt_toolbar.

  READ TABLE gt_prdord INTO gs_prdord INDEX 1.

  IF sy-subrc EQ 0.  "ALV에 한건이라도 있는 경우

    " 툴바 버튼 추가
    CLEAR ls_button.
    ls_button-function = 'MULTI_APP'.
    ls_button-quickinfo = '기간별 자동승인'.
    ls_button-icon      = icon_allow.
    ls_button-text = '  자동승인 '.

    IF gs_prdord-orstatus IS NOT INITIAL.
      ls_button-disabled = 'X'.
    ENDIF.

    INSERT ls_button INTO TABLE pc_object-&gt;mt_toolbar.

    CLEAR ls_button.
    ls_button-function = 'UPDATE'.
    ls_button-quickinfo = '관리자 반려취소'.
    ls_button-icon      = icon_flush.
    ls_button-text = '  반려취소 '.

    IF gs_prdord-orstatus IS INITIAL OR gs_prdord-orstatus EQ '1'.
      ls_button-disabled = 'X'.
    ENDIF.
    INSERT ls_button INTO TABLE pc_object-&gt;mt_toolbar.

  ELSE.  "ALV에 한 건도 없는 경우
    " 툴바 버튼 추가
    CLEAR ls_button.
    ls_button-function = 'MULTI_APP'.
    ls_button-quickinfo = '기간별 자동승인'.
    ls_button-icon      = icon_allow.
    ls_button-text = '  자동승인 '.
    ls_button-disabled = 'X'.

    INSERT ls_button INTO TABLE pc_object-&gt;mt_toolbar.

    CLEAR ls_button.
    ls_button-function = 'UPDATE'.
    ls_button-quickinfo = '관리자 반려취소'.
    ls_button-icon      = icon_flush.
    ls_button-text = '  반려취소 '.
    ls_button-disabled = 'X'.

    INSERT ls_button INTO TABLE pc_object-&gt;mt_toolbar.

  ENDIF.


ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form user_command</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*&      --&gt; E_UCOMM</font>
<font color ="#0000FF">*&      --&gt; LV_ROW</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM user_command  USING    pe_ucomm TYPE sy-ucomm
                            pv_row TYPE i.

  CASE pe_ucomm.

    WHEN 'MULTI_APP'.
      CALL SCREEN 110 STARTING AT 10  10.   "자동승인 팝업

    WHEN 'UPDATE'.
      PERFORM update_data.   "반려취소
  ENDCASE.

  PERFORM refresh_grid.
ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form update_data</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM update_data .
  DATA : lv_answer.
  DATA : lv_tabix TYPE sy-tabix.

  CALL METHOD go_grid-&gt;get_selected_rows
    IMPORTING
      et_index_rows = gt_rows.
  DESCRIBE TABLE gt_rows LINES sy-tfill.

  SORT gt_rows BY index DESCENDING.

  IF sy-tfill = 0.
    MESSAGE i003.        "선택된 행이 없습니다. 항목을 선택하세요..
    EXIT.
  ELSE.

    MESSAGE i000 WITH '반려 취소시 선택된 생산오더는 승인대기 상태로 변경됩니다.'.

    CALL FUNCTION 'POPUP_TO_CONFIRM'
      EXPORTING
        titlebar              = '반려 취소'
        text_question         = TEXT-004
        text_button_1         = '네'
        icon_button_1         = 'ICON_SYSTEM_OKAY'
        text_button_2         = '아니오'
        icon_button_2         = 'ICON_SYSTEM_CANCEL'
        default_button        = '1'
        display_cancel_button = ' '
        start_column          = 25
        start_row             = 15
      IMPORTING
        answer                = lv_answer
      EXCEPTIONS
        OTHERS                = 1.


    IF lv_answer EQ 1 .    "네 선택
      LOOP AT gt_rows INTO gs_row.
        lv_tabix = gs_row-index.

        READ TABLE gt_prdord INTO gs_prdord INDEX lv_tabix.
        gs_prdord-rej_txt  = ''.
        gs_prdord-orstatus = ' '.
        "수정 Timestamp
        gs_prdord-update_dt = sy-datum.
        gs_prdord-update_tm = sy-uzeit.
        gs_prdord-uuser = sy-uname.
        MOVE-CORRESPONDING gs_prdord TO gs_pp060.
        UPDATE zbbt_pp060 FROM gs_pp060.
        IF sy-subrc &lt;&gt; 0.
          ROLLBACK WORK.
        ELSE.
          COMMIT WORK.
        ENDIF.
      ENDLOOP.

      MESSAGE s000 WITH '관리자 권한으로 변경에 성공했습니다.'.

      CLEAR gt_prdord.
      PERFORM get_data.
      PERFORM make_data.
      " 다시 PBO 타도록 함 (Call screen 대신)
      CALL METHOD cl_gui_cfw=&gt;set_new_ok_code
        EXPORTING
          new_code = 'NEWCODE'.

    ELSEIF lv_answer EQ 2. "아니오 선택
      MESSAGE s000 WITH '오더 상태 변경을 취소했습니다.'.
    ENDIF.

  ENDIF.
ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form last_month_from_today</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM last_month_from_today .

  DATA : lv_date LIKE sy-datum.

  CONCATENATE sy-datum(6)'01' INTO lv_date.

  CALL FUNCTION 'RP_CALC_DATE_IN_INTERVAL'
    EXPORTING
      date      = lv_date
      days      = '00'
      months    = '01'
      signum    = '-'
      years     = '00'
    IMPORTING
      calc_date = lv_date.

  gv_last_month = lv_date.
ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form set_data</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& 초기값 설정</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM set_data .

  "자동승인
  gv_pord_l = sy-datum(6) && '01'.
  gv_pord_h = sy-datum.


  " 단건 승인/반려
  zbbt_pp060-porderno = gs_prdord-porderno.
  zbbt_pp060-pordwdat = gs_prdord-pordwdat.
  zbbt_pp060-empno = gs_prdord-empno.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form multi_approve</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& 생산오더 생성일(기간)으로 다건 자동 승인</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM multi_approve .

  REFRESH: gs_prdord-it_cell_style.
  CLEAR : gs_cell_style, gs_prdord-approval_porder, gv_count.

  SELECT COUNT( porderno ) AS count
    FROM zbbt_pp060
    WHERE pordwdat &gt;= @gv_pord_l
    AND pordwdat &lt;= @gv_pord_h
    AND orstatus IS INITIAL
    INTO @DATA(lv_count).

  LOOP AT gt_prdord INTO gs_prdord WHERE pordwdat &gt;= gv_pord_l
                                     AND pordwdat &lt;= gv_pord_h.

    gs_prdord-orstatus = '1'.                     "오더승인
    gs_prdord-color = 'C' && col_positive && '00'.
    gs_prdord-light = '3'.
    gs_prdord-approval_porder = '승인완료'.
<font color ="#0000FF">*    gs_prdord-pordflag = '1'.                      "생산진행</font>

    gs_prdord-update_dt = sy-datum.
    gs_prdord-update_tm = sy-uzeit.
    gs_prdord-uuser = sy-uname.

    MODIFY gt_prdord FROM gs_prdord TRANSPORTING orstatus color light pordflag
                                                 update_dt update_tm uuser.
    MOVE-CORRESPONDING gs_prdord TO gs_pp060.

    UPDATE zbbt_pp060 FROM gs_pp060.
    IF sy-subrc &lt;&gt; 0.
      ROLLBACK WORK.
    ELSE.
      COMMIT WORK.
    ENDIF.

    MESSAGE s052 WITH lv_count.     "생산오더 &건이 승인되었습니다.

  ENDLOOP.

  CLEAR gt_prdord.
  PERFORM get_data.
  PERFORM make_data.
  " 다시 PBO 타도록 함 (Call screen 대신)
  CALL METHOD cl_gui_cfw=&gt;set_new_ok_code
    EXPORTING
      new_code = 'NEWCODE'.


ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form approve_order</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM approve_order .

  DATA : lv_answer.

  CALL FUNCTION 'POPUP_TO_CONFIRM'
    EXPORTING
      titlebar              = '생산오더 승인'
      text_question         = '생산오더를 승인 처리하시겠습니까?'
      text_button_1         = '네'
      icon_button_1         = 'ICON_SYSTEM_OKAY'
      text_button_2         = '아니오'
      icon_button_2         = 'ICON_SYSTEM_CANCEL'
      default_button        = '1'
      display_cancel_button = ' '
      start_column          = 25
      start_row             = 15
    IMPORTING
      answer                = lv_answer
    EXCEPTIONS
      OTHERS                = 1.

  CASE lv_answer.
    WHEN '1'.
      READ TABLE gt_prdord INTO gs_prdord INDEX gv_tabix.

      gs_prdord-orstatus = '1'.
      gs_prdord-color = 'C' && col_positive && '00'.
      gs_prdord-light = '3'.
      gs_prdord-approval_porder = '승인완료'.
      gs_prdord-orstatus = '1'.    "오더승인

      gs_prdord-update_dt = sy-datum.
      gs_prdord-update_tm = sy-uzeit.
      gs_prdord-uuser = sy-uname.

      MODIFY gt_prdord FROM gs_prdord INDEX gv_tabix TRANSPORTING orstatus color light pordflag
                                                 update_dt update_tm uuser .

      MOVE-CORRESPONDING gs_prdord TO gs_pp060.
      MODIFY zbbt_pp060 FROM gs_pp060.
      IF sy-subrc &lt;&gt; 0.
        ROLLBACK WORK.
      ELSE.
        COMMIT WORK.
      ENDIF.
      MESSAGE s053 WITH gs_prdord-porderno.    "생산오더 &가 승인 되었습니다.

      CLEAR gt_prdord.
      PERFORM get_data.
      PERFORM make_data.
      " 다시 PBO 타도록 함 (Call screen 대신)
      CALL METHOD cl_gui_cfw=&gt;set_new_ok_code
        EXPORTING
          new_code = 'NEWCODE'.

    WHEN '2'.
      MESSAGE s000 WITH '생산오더 승인 작업을 취소했습니다.'.
  ENDCASE.

  CLEAR : gv_tabix.
  PERFORM refresh_grid.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form reject_order</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM reject_order .

  DATA : lv_answer.

  CALL FUNCTION 'POPUP_TO_CONFIRM'
    EXPORTING
      titlebar              = '생산오더 반려'
      text_question         = '생산오더를 반려 하시겠습니까?'
      text_button_1         = '네'
      icon_button_1         = 'ICON_SYSTEM_OKAY'
      text_button_2         = '아니오'
      icon_button_2         = 'ICON_SYSTEM_CANCEL'
      default_button        = '1'
      display_cancel_button = ' '
      start_column          = 25
      start_row             = 15
    IMPORTING
      answer                = lv_answer
    EXCEPTIONS
      OTHERS                = 1.

  CASE lv_answer.
    WHEN '1'.
      READ TABLE gt_prdord INTO gs_prdord INDEX gv_tabix.


      gs_prdord-rej_txt = zbbt_pp060-rej_txt.
      gs_prdord-orstatus = '2'.    "오더 반려
      gs_prdord-color = 'C' && col_negative && '00'.
      gs_prdord-light = '3'.
      gs_prdord-approval_porder = '오더 반려'.

      gs_prdord-update_dt = sy-datum.
      gs_prdord-update_tm = sy-uzeit.
      gs_prdord-uuser = sy-uname.


      MODIFY gt_prdord FROM gs_prdord INDEX gv_tabix.

      MOVE-CORRESPONDING gs_prdord TO gs_pp060.
      MODIFY zbbt_pp060 FROM gs_pp060.
      IF sy-subrc &lt;&gt; 0.
        ROLLBACK WORK.
      ELSE.
        COMMIT WORK.
      ENDIF.
      MESSAGE s054 WITH gs_prdord-porderno. "생산오더 &가 반려 되었습니다.

      CLEAR gt_prdord.
      PERFORM get_data.
      PERFORM make_data.
      " 다시 PBO 타도록 함 (Call screen 대신)
      CALL METHOD cl_gui_cfw=&gt;set_new_ok_code
        EXPORTING
          new_code = 'NEWCODE'.

    WHEN '2'.
      MESSAGE s000 WITH '생산오더 반려 작업을 취소했습니다.'.
  ENDCASE.

  CLEAR : gv_tabix.

  PERFORM display_table.



ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form pono_f4</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& 생산오더 Search Help 조건 삽입 (생성일 일자에 따라 그 기간의 오더만 조회되도록)</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM pono_f4 .

  DATA: lt_return       LIKE TABLE OF ddshretval      WITH HEADER LINE.

  TYPES: BEGIN OF ty_pono,
           porderno LIKE zbbt_pp060-porderno,
           pordwdat LIKE zbbt_pp060-pordwdat,
         END OF ty_pono.
  DATA : lt_pono TYPE TABLE OF ty_pono,
         ls_pono TYPE ty_pono.

  SELECT porderno, pordwdat
   INTO TABLE @lt_pono
   FROM zbbt_pp060
  WHERE pordwdat &gt;= @so_podt-low
    AND pordwdat &lt;= @so_podt-high
    ORDER BY porderno.


  CALL FUNCTION 'F4IF_INT_TABLE_VALUE_REQUEST'
    EXPORTING
      retfield     = 'PORDERNO'           "선택화면에서 선택한 필드명
      dynpprog     = sy-cprog
      dynpnr       = sy-dynnr
      dynprofield  = 'LT_PONO-PORDERNO'   "선택한 필드를 받을 화면상의 개체 이름
      window_title = '생산오더번호'            "팝업 제목"
      value_org    = 'S'                 "Return종류 C [Cell], S[Structure]
    TABLES
      value_tab    = lt_pono           "select때 사용한 인터널 테입블
      return_tab   = lt_return.        "선택한 값이 리턴될 인터널 테이블
ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form move_dynnr</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM move_dynnr .

  DATA : lv_answer.

  CALL FUNCTION 'POPUP_TO_CONFIRM'
    EXPORTING
      titlebar              = '화면 이동'
      text_question         = '생산오더를 반려 처리하시겠습니까?'
      text_button_1         = '네'
      icon_button_1         = 'ICON_SYSTEM_OKAY'
      text_button_2         = '아니오'
      icon_button_2         = 'ICON_SYSTEM_CANCEL'
      default_button        = '1'
      display_cancel_button = ' '
      start_column          = 25
      start_row             = 15
    IMPORTING
      answer                = lv_answer
    EXCEPTIONS
      OTHERS                = 1.


  CASE lv_answer.
    WHEN '1'.
      CALL SCREEN 130 STARTING AT 10  10. "반려사유 팝업
      LEAVE TO SCREEN 0.
    WHEN '2'.
      MESSAGE s000 WITH '생산오더 반려 작업을 취소했습니다.'.
  ENDCASE.

ENDFORM.
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& Form check_porderno</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
<font color ="#0000FF">*& --&gt;  p1        text</font>
<font color ="#0000FF">*& &lt;--  p2        text</font>
<font color ="#0000FF">*&---------------------------------------------------------------------*</font>
FORM check_porderno .
  DATA : lv_porder TYPE zbbt_pp060-porderno.

  IF  so_pono-low IS NOT INITIAL .
    SELECT SINGLE porderno INTO lv_porder
      FROM zbbt_pp060
      WHERE porderno = so_pono-low.

    IF sy-subrc &lt;&gt; 0.
      MESSAGE e032.   "허용되지 않는 입력값입니다.
    ENDIF.
  ENDIF.

  CLEAR lv_porder.

  IF so_pono-high IS NOT INITIAL..
    SELECT SINGLE porderno INTO lv_porder
      FROM zbbt_pp060
      WHERE porderno = so_pono-high.

    IF sy-subrc &lt;&gt; 0.
      MESSAGE e032.   "허용되지 않는 입력값입니다.
    ENDIF.
  ENDIF.
ENDFORM.
</pre>
<hr>
<font size="2" face = "Sans Serif">Extracted by Direct Download Enterprise version 1.3.1 - E.G.Mellodew. 1998-2005 UK. Sap Release 754
</font>
</body>
</html>
